<?php

/**
 * @file
 * Primary module hooks for DH Certificate module.
 */

/**
 * Implements hook_module_implements_alter().
 */
function dh_certificate_module_implements_alter(&$implementations, $hook) {
  // Remove this hook since we don't need to alter module implementation order
}

/**
 * Implements hook_dh_dashboard_blocks().
 */
function dh_certificate_dh_dashboard_blocks() {
  // Only provide dashboard integration if dh_dashboard is enabled
  if (!\Drupal::moduleHandler()->moduleExists('dh_dashboard')) {
    return [];
  }

  // Debug log the block registration
  \Drupal::logger('dh_certificate')->debug('Registering dashboard blocks');

  return [
    'certificate_progress' => [
      'title' => t('Certificate Progress'),
      'callback' => '\Drupal\dh_certificate\Controller\DHCertificateController::dashboardBlock',
      'weight' => 50,
      'theme' => 'dh_dashboard_progress',  // Explicitly set theme hook
    ],
  ];
}

/**
 * Implements hook_theme().
 */
function dh_certificate_theme($existing, $type, $theme, $path) {
  return [
    'dh_certificate_progress' => [
      'variables' => [
        'progress' => NULL,
        'is_admin' => FALSE,
        'admin_url' => NULL,
        'debug' => NULL,  // Add debug to variables
      ],
    ],
  ];
}

/**
 * Implements hook_entity_type_alter().
 */
function dh_certificate_entity_type_alter(array &$entity_types) {
  // Add certificate-related fields to user profiles if needed
  if (isset($entity_types['user'])) {
    $entity_types['user']->setHandlerClass('form', [
      'default' => 'Drupal\dh_certificate\Form\UserCertificateForm',
    ]);
  }
}

/**
 * Implements hook_entity_extra_field_info().
 */
function dh_certificate_entity_extra_field_info() {
  $extra = [];
  $extra['user']['user']['display']['certificate_progress_summary'] = [
    'label' => t('Certificate Progress Summary'),
    'description' => t('Shows progress towards certificate completion'),
    'weight' => 100,
    'visible' => TRUE,
  ];
  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function dh_certificate_user_view(array &$build, $account, $display, $view_mode) {
  if ($display->getComponent('certificate_progress_summary')) {
    $progress_service = \Drupal::service('dh_certificate.progress');
    if ($account instanceof \Drupal\user\UserInterface) {
      $progress = $progress_service->getUserProgress($account);
    } else {
      $progress = $progress_service->getUserProgressById($account->id());
    }
    $build['certificate_progress_summary'] = [
      '#theme' => 'certificate_progress_block',
      '#progress' => $progress,
    ];
  }
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function dh_certificate_theme_suggestions_dh_certificate_progress_block(array $variables) {
  $suggestions = [];
  if (!empty($variables['progress'])) {
    $suggestions[] = 'dh_certificate_progress_block__' . $variables['progress']->bundle();
  }
  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function dh_certificate_preprocess_certificate_progress_block(&$variables) {
  $user = \Drupal::currentUser();
  $progress_service = \Drupal::service('dh_certificate.progress');
  
  // Add admin status
  $variables['is_admin'] = $user->hasPermission('administer dh certificate');
  
  // Get progress data
  $progress = $progress_service->getUserProgress($user);
  
  // Structure the data for the template
  $variables['progress'] = $progress;
  $variables['courses'] = $progress['courses'] ?? [];
  $variables['completion'] = [
    'total_courses' => $progress['total_courses'] ?? 0,
    'completed_courses' => $progress['completed_courses'] ?? 0,
    'total_credits' => $progress['total_credits'] ?? 0,
    'required_credits' => $progress['required_credits'] ?? 12,
    'percentage' => $progress['total_percentage'] ?? 0,
  ];
  
  $variables['#attached']['library'][] = 'dh_certificate/certificate-progress';
}

/**
 * Implements hook_preprocess_HOOK().
 */
function dh_certificate_preprocess_certificate_progress_detail(&$variables) {
  $variables['#attached']['library'][] = 'dh_certificate/certificate-progress';
  
  if (!empty($variables['progress'])) {
    $progress_manager = \Drupal::service('dh_certificate.progress_manager');
    $variables['requirements'] = $progress_manager->getRequirementsByCategory($variables['progress']);
    $variables['remaining_requirements'] = $progress_manager->getRemainingRequirements($variables['progress']);
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function dh_certificate_preprocess_dh_certificate_progress(&$variables) {
  // Removed detailed debug logging to prevent memory issues
  if (!empty($variables['debug'])) {
    \Drupal::logger('dh_certificate')->debug('Debug enabled for certificate progress');
  }
}

/**
 * Prepares variables for dh_certificate_progress template.
 */
function template_preprocess_dh_certificate_progress(&$variables) {
  // Ensure admin_url is available to the template
  if (!isset($variables['admin_url'])) {
    $variables['admin_url'] = NULL;
  }
}

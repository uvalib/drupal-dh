<?php

/**
 * @file
 * Primary module hooks for DH Certificate module.
 */

/**
 * Implements hook_module_implements_alter().
 */
function dh_certificate_module_implements_alter(&$implementations, $hook) {
  // Remove this hook since we don't need to alter module implementation order
}

/**
 * Implements hook_dh_dashboard_blocks().
 */
function dh_certificate_dh_dashboard_blocks() {
  if (!\Drupal::moduleHandler()->moduleExists('dh_dashboard')) {
    return [];
  }

  return [
    'certificate_progress' => [
      'title' => t('Certificate Progress'),
      'callback' => '\Drupal\dh_certificate\Controller\DHCertificateController::dashboardBlock',
      'weight' => 50,
      'theme' => 'dh_dashboard_progress',
    ],
    'certificate_requirements' => [
      'title' => t('Certificate Requirements'),
      'callback' => '\Drupal\dh_certificate\Controller\DHCertificateController::requirementsBlock',
      'weight' => 51,
      'theme' => 'dh_dashboard_requirements',
    ],
  ];
}

/**
 * Implements hook_theme().
 */
function dh_certificate_theme($existing, $type, $theme, $path) {
  return [
    'certificate_progress_block' => [
      'variables' => [
        'progress' => NULL,
        'user' => NULL,
        'is_admin' => FALSE,
        'manage_url' => NULL,
        'debug' => NULL,
        'admin_links' => NULL,
        'attributes' => [],
      ],
      'template' => 'dh-certificate-progress-block', // This matches the actual filename
    ],
    'dh_dashboard_progress' => [
      'variables' => [
        'progress' => NULL,
        'courses' => [],
        'completion' => [],
      ],
    ],
    'dh_dashboard_requirements' => [
      'variables' => [
        'requirements' => [],
        'remaining' => [],
      ],
    ],
    'dh_certificate_requirements' => [
      'variables' => [
        'title' => NULL,
        'requirements' => [],
      ],
    ],
    'dh_certificate_course_listing' => [
      'variables' => [
        'title' => NULL,
        'categories' => [],
        'view_mode' => 'student',
        'paths' => [],
        'show_debug' => TRUE,  // Changed default to TRUE
        'default_view' => 'grid',
        'course_data' => [],
      ],
      'template' => 'dh-certificate-course-listing',
    ],
    'dh_certificate_admin_overview' => [
      'variables' => [
        'title' => NULL,
        'stats' => [],
      ],
    ],
    'dh_certificate_user_progress' => [
      'variables' => [
        'title' => NULL,
        'progress' => [],
      ],
    ],
    'dh_certificate_enrollment_list' => [
      'variables' => [
        'title' => NULL,
        'enrollments' => [],
      ],
      'template' => 'dh-certificate-enrollment-list',
    ],
    'dh_certificate_enrollment_form' => [
      'render element' => 'form',
      'template' => 'dh-certificate-enrollment-form',
    ],
        'dh_certificate_enrollment_delete_form' => [
      'render element' => 'form',
      'template' => 'dh-certificate-enrollment-delete-form',
    ],
    'dh_certificate_monitor_overview' => [
      'variables' => [
        'monitors' => [],
      ],
    ],
    'dh_certificate_monitor_detail' => [
      'variables' => [
        'monitor_id' => NULL,
        'changes' => [],
        'last_checked' => NULL,
      ],
    ],
    'dh_certificate_structure_monitor' => [
      'variables' => [
        'content' => NULL,
      ],
    ],
    'dh_certificate_progress_block' => [
      'variables' => [
        'progress' => NULL,
        'is_admin' => FALSE,
        'manage_url' => NULL,
        'debug' => NULL,
      ],
      'template' => 'dh-certificate-progress-block',
    ],
  ];
}

/**
 * Implements hook_entity_extra_field_info().
 */
function dh_certificate_entity_extra_field_info() {
  // Remove the entire extra fields array since we don't want automatic placement
  return [];
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function dh_certificate_user_view(array &$build, $account, $display, $view_mode) {
  // Remove the automatic progress block placement
  return;
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function dh_certificate_theme_suggestions_dh_certificate_progress_block(array $variables) {
  $suggestions = [];
  if (!empty($variables['progress'])) {
    $suggestions[] = 'dh_certificate_progress_block__' . $variables['progress']->bundle();
  }
  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK() for certificate_progress_block.
 */
function dh_certificate_preprocess_certificate_progress_block(&$variables) {
  // Update service name from progress_manager to progress
  $progress_manager = \Drupal::service('dh_certificate.progress');
  $current_user = \Drupal::currentUser();
  
  $progress = $progress_manager->getUserProgress($current_user);
  if ($progress) {
    $variables['progress'] = $progress;
  }

  if ($current_user->hasPermission('administer dh certificate')) {
    $variables['is_admin'] = TRUE;
    $variables['admin_links'] = [
      '#type' => 'operations',
      '#links' => [
        'manage' => [
          'title' => t('Manage'),
          'url' => \Drupal\Core\Url::fromRoute('dh_certificate.admin'),
        ],
      ],
    ];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function dh_certificate_preprocess_dh_certificate_progress(&$variables) {
  // Removed detailed debug logging to prevent memory issues
  if (!empty($variables['debug'])) {
    \Drupal::logger('dh_certificate')->debug('Debug enabled for certificate progress');
  }
}

/**
 * Prepares variables for dh_certificate_progress template.
 */
function template_preprocess_dh_certificate_progress(&$variables) {
  // Ensure admin_url is available to the template
  if (!isset($variables['admin_url'])) {
    $variables['admin_url'] = NULL;
  }
}

/**
 * Implements hook_help().
 */
function dh_certificate_help($route_name, \Drupal\Core\Routing\RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.dh_certificate':
      return '<p>' . t('The Digital Humanities Certificate module manages student progress tracking and certificate requirements.') . '</p>';
    
    case 'dh_certificate.admin':
      return '<p>' . t('Configure certificate requirements and manage student progress.') . '</p>';
  }
}

/**
 * Implements hook_page_attachments().
 */
function dh_certificate_page_attachments(array &$attachments) {
  // Attach the debug-tree library to all pages
  $attachments['#attached']['library'][] = 'dh_certificate/debug-tree';
}

/**
 * Implements hook_cron().
 */
function dh_certificate_cron() {
  $storage = \Drupal::entityTypeManager()->getStorage('course_enrollment');
  
  // Find stale enrollments (older than 30 days with no activity)
  $ids = $storage->getQuery()
    ->accessCheck(FALSE)
    ->condition('status', 'pending')
    ->condition('enrolled_date', \Drupal::time()->getRequestTime() - (30 * 86400), '<')
    ->execute();

  if ($ids) {
    $enrollments = $storage->loadMultiple($ids);
    $storage->delete($enrollments);
    \Drupal::logger('dh_certificate')->notice('Cleaned up @count stale enrollments', [
      '@count' => count($ids)
    ]);
  }
}

/**
 * Implements hook_entity_type_alter().
 */
function dh_certificate_entity_type_alter(array &$entity_types) {
  if (isset($entity_types['requirement_type_template'])) {
    $entity_types['requirement_type_template']->setHandlerClass(
      'form', [
        'add' => 'Drupal\dh_certificate\Form\RequirementTypeTemplateFormImpl',
        'edit' => 'Drupal\dh_certificate\Form\RequirementTypeTemplateFormImpl',
        'delete' => 'Drupal\Core\Entity\EntityDeleteForm',
      ]
    );
  }
}
